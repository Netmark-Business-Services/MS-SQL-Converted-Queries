    
WITH RecentClaims AS (
    SELECT
        cf.*,
        ROW_NUMBER() OVER (PARTITION BY cf.CLAIM_HCC_ID ORDER BY cf.MOST_RECENT_PROCESS_TIME DESC) as row_num
    FROM
        payor_dw.claim_fact cf
    WHERE
        cf.IS_CONVERTED = 'N' AND
        cf.IS_TRIAL_CLAIM = 'N' AND
        cf.IS_CURRENT = 'Y' AND
        cf.ENTRY_TIME >= TO_TIMESTAMP('2024-07-02 00:00:00', 'YYYY-MM-DD HH24:MI:SS')
)
SELECT 
    rc.CLAIM_HCC_ID,
    rc.CLAIM_STATUS,
    aclf.CLAIM_LINE_HCC_ID,
    aclf.CLAIM_LINE_STATUS_CODE,    
    aclf.SERVICE_CODE,
    am.ADJUDICATION_MESSAGE_CODE AS Message_Code, 
    am.ADJUDICATION_MESSAGE_DESC AS MESSAGE_DESC, 
    dd1.DATE_VALUE AS SERVICE_START_DATE,
    dd2.DATE_VALUE AS SERVICE_END_DATE,
    dd.DATE_VALUE AS RECEIPT_DATE,
    TRUNC(CURRENT_DATE) -  TRUNC(dd.DATE_VALUE) AS day_difference_receipt,
    rc.ENTRY_TIME,
    rc.MOST_RECENT_PROCESS_TIME 
FROM
    RecentClaims rc
LEFT JOIN
    payor_dw.ALL_CLAIM_LINE_FACT aclf ON rc.CLAIM_FACT_KEY = aclf.CLAIM_FACT_KEY
LEFT JOIN
    payor_dw.CLAIM_SOURCE_CODE csc ON rc.CLAIM_SOURCE_KEY = csc.CLAIM_SOURCE_KEY
LEFT JOIN
    payor_dw.DATE_DIMENSION dd ON rc.RECEIPT_DATE_KEY = dd.DATE_KEY
LEFT JOIN
    payor_dw.DATE_DIMENSION dd1 ON aclf.SERVICE_START_DATE_KEY = dd1.DATE_KEY
LEFT JOIN
    payor_dw.DATE_DIMENSION dd2 ON aclf.SERVICE_END_DATE_KEY = dd2.DATE_KEY
LEFT JOIN 
    payor_dw.CLAIM_LINE_FACT_TO_ADJD_MSG clfam ON aclf.CLAIM_LINE_FACT_KEY = clfam.CLAIM_LINE_FACT_KEY 
LEFT JOIN 
    payor_dw.ADJUDICATION_MESSAGE am ON clfam.ADJUDICATION_MESSAGE_KEY = am.ADJUDICATION_MESSAGE_KEY 
WHERE
    --rc.CLAIM_STATUS = 'Needs Review' AND 
    am.ADJUDICATION_MESSAGE_CODE = 'UMD18' AND 
    aclf.CLAIM_LINE_STATUS_CODE = 'd' AND 
    (aclf.SERVICE_CODE BETWEEN 'V5030' AND 'V5080' OR
     aclf.SERVICE_CODE BETWEEN 'V5120' AND 'V5150' OR
     aclf.SERVICE_CODE IN ('V5171', 'V5172', 'V5181', 'V5190', 'V5211', 'V5212', 'V5213', 'V5214', 'V5215', 
                           'V5221', 'V5230', 'V5298')) AND
    rc.row_num = 1;
