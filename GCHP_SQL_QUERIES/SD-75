WITH RecentClaims AS (
  SELECT 
    cf.*, 
    ROW_NUMBER() OVER (
      PARTITION BY cf.CLAIM_HCC_ID 
      ORDER BY 
        cf.MOST_RECENT_PROCESS_TIME DESC
    ) AS row_num 
  FROM 
    payor_dw.claim_fact cf 
  WHERE 
    cf.IS_CONVERTED = 'N' 
    AND cf.IS_TRIAL_CLAIM = 'N' 
    AND cf.ENTRY_TIME >= TO_TIMESTAMP(
      '2024-07-02 00:00:00', 'YYYY-MM-DD HH24:MI:SS'
    )
), 
AggregatedClaimLines AS (
  SELECT 
    CLAIM_FACT_KEY, 
    SUM(BILLED_AMOUNT) AS TOTAL_BILLED_AMOUNT, 
    SUM(PAID_AMOUNT) AS TOTAL_PAID_AMOUNT 
  FROM 
    payor_dw.ALL_CLAIM_LINE_FACT 
  GROUP BY 
    CLAIM_FACT_KEY
) 
SELECT 
  DISTINCT rc.CLAIM_HCC_ID, 
  --aclf.CLAIM_LINE_HCC_ID,
  rc.CLAIM_STATUS, 
  rc.CLAIM_TYPE_NAME, 
  csc.CLAIM_SOURCE_NAME, 
  dd.DATE_VALUE AS RECEIPT_DATE, 
  TRUNC(CURRENT_DATE) - TRUNC(dd.DATE_VALUE) AS day_difference_receipt, 
  rc.ENTRY_TIME, 
  rc.MOST_RECENT_PROCESS_TIME, 
  am.ADJUDICATION_MESSAGE_CODE AS Message_Code, 
  am.ADJUDICATION_MESSAGE_DESC AS MESSAGE_DESC, 
  rc.SI_SUPPLIER_NAME, 
  ashf.SUPPLIER_NPI AS ASHF_SUPPLIER_NPI, 
  ashf.SUPPLIER_HCC_ID AS ASHF_SUPPLIER_HCC_ID, 
  PT.PROVIDER_TAXONOMY_CODE, 
  pt.CLASSIFICATION AS Supplier_Classification, 
  rc.CLAIM_LEVEL_SUBMITTED_CHARGES AS BILLED_AMOUNT, 
  aclf_agg.TOTAL_PAID_AMOUNT, 
  suppaydate.DATE_VALUE AS Payment_Date 
FROM 
  RecentClaims rc 
  LEFT JOIN AggregatedClaimLines aclf_agg ON rc.CLAIM_FACT_KEY = aclf_agg.CLAIM_FACT_KEY 
  LEFT JOIN payor_dw.ALL_CLAIM_LINE_FACT aclf ON rc.CLAIM_FACT_KEY = aclf.CLAIM_FACT_KEY 
  LEFT JOIN payor_dw.CLAIM_LINE_FACT_TO_ADJD_MSG clfam ON aclf.CLAIM_LINE_FACT_KEY = clfam.CLAIM_LINE_FACT_KEY 
  LEFT JOIN payor_dw.CLAIM_SOURCE_CODE csc ON rc.CLAIM_SOURCE_KEY = csc.CLAIM_SOURCE_KEY 
  LEFT JOIN payor_dw.PAYMENT_FACT_TO_CLAIM_FACT pftcf ON rc.CLAIM_FACT_KEY = pftcf.CLAIM_FACT_KEY 
  LEFT JOIN payor_dw.PAYMENT_FACT pf ON pftcf.PAYMENT_FACT_KEY = pf.PAYMENT_FACT_KEY 
  LEFT JOIN payor_dw.ADJUDICATION_MESSAGE am ON clfam.ADJUDICATION_MESSAGE_KEY = am.ADJUDICATION_MESSAGE_KEY 
  LEFT JOIN payor_dw.DATE_DIMENSION dd ON rc.RECEIPT_DATE_KEY = dd.DATE_KEY 
  LEFT JOIN payor_dw.ALL_SUPPLIER_HISTORY_FACT ashf ON rc.SUPPLIER_KEY = ashf.SUPPLIER_KEY 
  LEFT JOIN payor_dw.PROVIDER_TAXONOMY pt ON ashf.PRIMARY_CLASSIFICATION_KEY = pt.PROVIDER_TAXONOMY_KEY 
  LEFT JOIN payor_dw.DATE_DIMENSION suppaydate ON pf.PAYMENT_DATE_KEY = suppaydate.DATE_KEY 
  LEFT JOIN payor_dw.POSTAL_ADDRESS pa ON rc.SUBMITTED_PAY_TO_ADDRESS_KEY = pa.POSTAL_ADDRESS_KEY 
WHERE 
  am.ADJUDICATION_MESSAGE_CODE = '172' 
  AND pt.PROVIDER_TAXONOMY_CODE = '314000000X' 
  AND rc.row_num = 1;
